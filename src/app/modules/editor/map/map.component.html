<app-side-menu [backUrl]="getBackUrl()"></app-side-menu>
<div class="map-div" *ngIf="files.length > 0">
  <div class="information-table" *ngIf="getSelectedPoint() as selectedPoint">
    <div class="d-flex justify-content-center" *ngIf="files.length > 1">
      <h4>{{ files[selectedFile].metadata?.name }}</h4>
    </div>
    <div
      class="d-flex justify-content-center"
      [ngClass]="files.length > 1 ? 'mt-2' : ''"
    >
      <h5 *ngIf="selectedType === 'waypoints'">Bod {{ selectedIndex + 1 }}</h5>
      <h5 *ngIf="selectedType === 'tracks'">Trasa {{ selectedIndex + 1 }}</h5>
      <h5 *ngIf="selectedType === 'routes'">Cesta {{ selectedIndex + 1 }}</h5>
    </div>
    <ng-container *ngIf="getSelectedSection() as selectedSection">
      <span>Jméno: {{ selectedSection.name }}</span>
      <span>Popis: {{ selectedSection.desc }}</span>
      <span>Typ: {{ selectedSection.type }}</span>
      <span>Počet bodů: {{ selectedSection.points.length }}</span>
    </ng-container>
    <div
      class="d-flex justify-content-center mt-3"
      *ngIf="selectedType !== 'waypoints'"
    >
      <h6>Bod {{ subSelectedIndex + 1 }}</h6>
    </div>
    <ng-container *ngIf="selectedType === 'waypoints'">
      <span>Jméno {{ selectedPoint["name"] }}</span>
      <span>Popis: {{ selectedPoint["desc"] }}</span>
      <span>Komentář: {{ selectedPoint["cmt"] }}</span>
    </ng-container>
    <span>Lat: {{ selectedPoint.lat }}</span>
    <span>Lon: {{ selectedPoint.lon }}</span>
    <span *ngIf="selectedPoint.ele && selectedPoint.ele > 0"
      >Ele: {{ selectedPoint.ele }}</span
    >
    <span *ngIf="selectedPoint.time"
      >Time: {{ selectedPoint.time | date }}</span
    >
    <div
      class="d-flex justify-content-center mt-3"
      *ngIf="selectedType === 'waypoints'"
    >
      <button
        type="button"
        class="btn btn-warning"
        (click)="removePoint(selectedIndex)"
      >
        Smazat bod
      </button>
    </div>
    <div
      class="d-flex gap-2 justify-content-center mt-3"
      *ngIf="selectedType !== 'waypoints'"
    >
      <button
        type="button"
        class="btn btn-warning"
        (click)="removePoint(subSelectedIndex)"
      >
        Smazat bod
      </button>
      <button
        type="button"
        class="btn btn-danger"
        *ngIf="selectedType === 'routes'"
        (click)="RemoveGroup()"
      >
        Smazat cestu
      </button>
      <button
        type="button"
        class="btn btn-danger"
        *ngIf="selectedType === 'tracks'"
        (click)="RemoveGroup()"
      >
        Smazat trasu
      </button>
    </div>
  </div>
  <div class="side-menu gap-3">
    <div class="d-flex justify-content-center align-items-center">
      <h4>Informace</h4>
    </div>
    <ng-container *ngIf="files.length > 1">
      <select
        class="form-select"
        [(ngModel)]="selectedFile"
        (ngModelChange)="showPointInfo = false"
      >
        <option *ngFor="let file of files; let i = index" [value]="i">
          {{ file.metadata?.name }}
        </option>
      </select>
    </ng-container>
    <select
      class="form-select"
      [(ngModel)]="selectedType"
      (ngModelChange)="showPointInfo = false"
    >
      <option value="waypoints">Body</option>
      <option value="tracks">Trasy</option>
      <option value="routes">Cesty</option>
    </select>
    <mat-slide-toggle [(ngModel)]="addPoint"
      >Mód přidávání bodů</mat-slide-toggle
    >
    <button
      (click)="addGroup()"
      class="btn btn-primary"
      *ngIf="selectedType !== 'waypoints'"
    >
      Přidat {{ selectedType === "tracks" ? "trasu" : "cestu" }}
    </button>
    <div class="d-flex flex-column gap-2">
      <ng-container *ngIf="selectedType === 'waypoints'">
        <div
          *ngFor="let point of files[selectedFile].waypoints; let i = index"
          class="d-flex flex-column cursor-pointer"
          (click)="waypointClick(selectedFile, i)"
        >
          <span
            [ngClass]="
              selectedIndex === i && showPointInfo ? 'font-weight-bold' : ''
            "
            >Bod {{ i + 1 }}</span
          >
          <span>Jméno: {{ point.name }}</span>
        </div>
      </ng-container>
      <ng-container *ngIf="selectedType === 'tracks'">
        <div
          *ngFor="let group of files[selectedFile].tracks; let i = index"
          class="d-flex flex-column cursor-pointer"
          (click)="trackPointClick(selectedFile, i, 0)"
        >
          <span
            [ngClass]="
              selectedIndex === i && showPointInfo ? 'font-weight-bold' : ''
            "
            >Trasa {{ i + 1 }}</span
          >
          <span>Jméno: {{ group.name }}</span>
          <span>Počet bodů: {{ group.points.length }}</span>
        </div>
      </ng-container>
      <ng-container *ngIf="selectedType === 'routes'">
        <div
          *ngFor="let group of files[selectedFile].routes; let i = index"
          class="d-flex flex-column cursor-pointer"
          (click)="routePointClick(selectedFile, i, 0)"
        >
          <span
            [ngClass]="
              selectedIndex === i && showPointInfo ? 'font-weight-bold' : ''
            "
            >Cesta {{ i + 1 }}</span
          >
          <span>Jméno: {{ group.name }}</span>
          <span>Počet bodů: {{ group.points.length }}</span>
        </div>
      </ng-container>
    </div>
  </div>
  <agm-map
    *ngIf="lat && lng"
    [latitude]="lat"
    [longitude]="lng"
    [zoom]="zoom"
    (mapClick)="mapClick($event)"
    (mapRightClick)="mapRightClick()"
    [streetViewControl]="false"
  >
    <ng-container *ngFor="let file of files; let fileIndex = index">
      <agm-marker
        *ngFor="let point of file.waypoints; let i = index"
        [latitude]="point.lat"
        [longitude]="point.lon"
        (dragEnd)="waypointDrag($event, fileIndex, i)"
        (markerClick)="waypointClick(fileIndex, i)"
        (markerRightClick)="waypointRightClick(fileIndex, i)"
        [markerDraggable]="true"
        [opacity]="
          showPointInfo && selectedType === 'waypoints' && selectedIndex === i
            ? 1.0
            : 0.88
        "
      ></agm-marker>
      <ng-container *ngFor="let track of file.tracks; let i1 = index">
        <agm-marker
          *ngFor="let point of track.points; let i2 = index"
          [latitude]="point.lat"
          [longitude]="point.lon"
          (dragEnd)="trackPointDrag($event, fileIndex, i1, i2)"
          (markerClick)="trackPointClick(fileIndex, i1, i2)"
          (markerRightClick)="trackPointRightClick(fileIndex, i1, i2)"
          [opacity]="
            showPointInfo &&
            selectedType === 'tracks' &&
            selectedIndex === i1 &&
            subSelectedIndex === i2
              ? 1.0
              : 0.88
          "
          [markerDraggable]="true"
        ></agm-marker>
        <agm-polyline
          [strokeColor]="
            showPointInfo && selectedType === 'tracks' && selectedIndex === i1
              ? '#8B0000'
              : '#556B2F'
          "
          [strokeWeight]="
            showPointInfo && selectedType === 'tracks' && selectedIndex === i1
              ? 10
              : 5
          "
          (lineClick)="trackLineClick(fileIndex, i1)"
        >
          <agm-polyline-point
            *ngFor="let mapData of track.points"
            [latitude]="mapData.lat"
            [longitude]="mapData.lon"
          ></agm-polyline-point>
        </agm-polyline>
      </ng-container>
      <ng-container *ngFor="let route of file.routes; let i1 = index">
        <agm-marker
          *ngFor="let point of route.points; let i2 = index"
          [latitude]="point.lat"
          [longitude]="point.lon"
          (dragEnd)="routePointDrag($event, fileIndex, i1, i2)"
          (markerClick)="routePointClick(fileIndex, i1, i2)"
          (markerRightClick)="routePointRightClick(fileIndex, i1, i2)"
          [opacity]="
            showPointInfo &&
            selectedType === 'routes' &&
            selectedIndex === i1 &&
            subSelectedIndex === i2
              ? 1.0
              : 0.88
          "
          [markerDraggable]="true"
        ></agm-marker>
        <agm-polyline
          [strokeColor]="
            showPointInfo && selectedType === 'routes' && selectedIndex === i1
              ? '#8B0000'
              : '#008B8B'
          "
          [strokeWeight]="
            showPointInfo && selectedType === 'routes' && selectedIndex === i1
              ? 10
              : 5
          "
          (lineClick)="routeLineClick(fileIndex, i1)"
        >
          <agm-polyline-point
            *ngFor="let mapData of route.points"
            [latitude]="mapData.lat"
            [longitude]="mapData.lon"
          ></agm-polyline-point>
        </agm-polyline>
      </ng-container>
    </ng-container>
  </agm-map>
</div>
